# 常见问题解决方案

## 问题1：OpenRouter 404错误 - 数据隐私策略

### 错误信息
```
Error code: 404 - {'error': {'message': 'No endpoints found matching your data policy (Free model publication). Configure: https://openrouter.ai/settings/privacy', 'code': 404}}
```

### 原因
使用OpenRouter的免费模型（如`deepseek/deepseek-chat-v3.1:free`）需要配置数据隐私策略。

### 解决方案

#### 方案一：配置数据隐私（使用免费模型）
1. 访问 https://openrouter.ai/settings/privacy
2. 登录您的OpenRouter账号
3. 在Privacy Settings页面配置数据隐私策略
4. 勾选允许使用免费模型的选项
5. 保存设置
6. 刷新页面重新上传文档

#### 方案二：使用付费模型（推荐，已配置）
已将模型更改为 `deepseek/deepseek-chat`（付费版），无需配置隐私策略。

**当前配置（.env文件）：**
```
OPENAI_API_KEY=your_api_key_here
OPENAI_BASE_URL=https://openrouter.ai/api/v1
OPENAI_MODEL=deepseek/deepseek-chat
```

**费用说明：**
- DeepSeek付费版非常便宜（约$0.14/百万tokens输入，$0.28/百万tokens输出）
- 分析一份简历大约消耗1000-3000 tokens
- 估算成本：每份简历约 $0.0003-0.001（不到1分钱）

#### 方案三：更换其他模型
如果您有其他API，可以修改`.env`文件：

```bash
# 使用其他OpenRouter支持的模型
OPENAI_MODEL=anthropic/claude-3-haiku  # Claude便宜版
OPENAI_MODEL=openai/gpt-3.5-turbo     # OpenAI
OPENAI_MODEL=google/gemini-pro         # Google

# 或使用直连OpenAI
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_API_KEY=your_openai_key
```

### 验证配置
重启服务器后测试：
```bash
# 停止服务器
lsof -ti:5001 | xargs kill -9

# 启动服务器
python app.py

# 访问测试
http://localhost:5001/chat
```

---

## 问题2：端口被占用

### 错误信息
```
Address already in use
Port 5001 is in use by another program
```

### 解决方案

#### 方案一：关闭占用端口的程序
```bash
# 查看占用端口的进程
lsof -ti:5001

# 关闭进程
lsof -ti:5001 | xargs kill -9
```

#### 方案二：更换端口
编辑 `app.py` 最后一行：
```python
app.run(debug=True, host='0.0.0.0', port=5002)  # 改为5002或其他端口
```

---

## 问题3：PDF文本提取失败

### 错误信息
```
提取PDF文本失败: XXX
```

### 可能原因
1. PDF是扫描版（图片格式）
2. PDF有密码保护
3. PDF格式损坏

### 解决方案
1. 确保PDF是可复制文本的（不是扫描图片）
2. 移除PDF密码保护
3. 尝试重新导出PDF
4. 使用其他格式的简历（Word、TXT）

---

## 问题4：AI回复很慢

### 原因
- 大模型推理需要时间
- 网络延迟
- API并发限制

### 解决方案
1. **正常情况**：等待10-30秒是正常的
2. **网络问题**：检查网络连接
3. **API限制**：免费版可能有速率限制，考虑使用付费版
4. **简历过长**：简历内容太多会增加处理时间

---

## 问题5：上传后没有反应

### 检查清单
- [ ] 文件格式是否为PDF
- [ ] 文件大小是否小于16MB
- [ ] 浏览器控制台是否有错误（按F12查看）
- [ ] 服务器是否正在运行
- [ ] 网络连接是否正常

### 调试方法
1. 打开浏览器开发者工具（F12）
2. 查看Console标签的错误信息
3. 查看Network标签的请求状态
4. 查看服务器终端的日志输出

---

## 问题6：服务器启动失败

### 检查步骤
1. **检查Python版本**
```bash
python --version  # 需要3.7+
```

2. **检查依赖是否安装**
```bash
pip list | grep -E "Flask|openai|PyPDF2|python-docx"
```

3. **重新安装依赖**
```bash
pip install -r requirements.txt
```

4. **查看详细错误**
```bash
python app.py  # 不要后台运行，查看完整错误信息
```

---

## 问题7：AI分析结果不准确

### 优化建议
1. **简历格式**：确保简历格式清晰，信息结构化
2. **文件质量**：使用高质量的PDF文件
3. **提问技巧**：
   - 具体明确的问题效果更好
   - 避免过于宽泛的问题
   - 可以分步骤提问

### 示例
❌ 不好的问题："这个人怎么样？"
✅ 好的问题："这位候选人的Python开发经验有几年？主要做过哪些项目？"

---

## 问题8：对话历史丢失

### 原因
当前对话历史存储在内存中，以下情况会导致丢失：
- 服务器重启
- 浏览器刷新（前端丢失文档ID）
- 手动清除对话

### 解决方案
#### 短期方案（当前实现）
- 避免服务器重启
- 记录文档ID
- 重要对话及时记录

#### 长期方案（可扩展）
修改 `document_chat.py`，将对话历史保存到数据库：
```python
# 将对话保存到SQLite
def save_conversation_to_db(doc_id, conversation):
    # 实现数据库保存逻辑
    pass
```

---

## 问题9：API密钥无效

### 错误信息
```
Error: Invalid API key
```

### 解决方案
1. **检查.env文件**
```bash
cat .env
```

2. **验证API密钥**
- 登录 https://openrouter.ai/keys
- 检查密钥是否有效
- 确认密钥有足够额度

3. **重新配置**
```bash
# 编辑.env文件
nano .env

# 或使用命令
cat > .env << 'EOF'
OPENAI_API_KEY=your_new_key
OPENAI_BASE_URL=https://openrouter.ai/api/v1
OPENAI_MODEL=deepseek/deepseek-chat
EOF
```

4. **重启服务器**
```bash
lsof -ti:5001 | xargs kill -9
python app.py
```

---

## 问题10：中文简历乱码

### 原因
- PDF编码问题
- 字体嵌入问题

### 解决方案
1. **重新导出PDF**：使用"另存为PDF"而不是"打印为PDF"
2. **检查字体**：确保PDF嵌入了中文字体
3. **尝试其他格式**：使用Word格式（.docx）
4. **使用AI分析**：即使提取的文本有些许问题，AI通常也能理解

---

## 获取帮助

### 查看日志
```bash
# 查看服务器实时日志
tail -f app.log

# 或者直接运行查看输出
python app.py
```

### 测试API连接
创建测试文件 `test_api.py`：
```python
import os
from dotenv import load_dotenv
from openai import OpenAI

load_dotenv()

client = OpenAI(
    api_key=os.getenv('OPENAI_API_KEY'),
    base_url=os.getenv('OPENAI_BASE_URL')
)

try:
    response = client.chat.completions.create(
        model=os.getenv('OPENAI_MODEL'),
        messages=[{"role": "user", "content": "Hello"}],
        max_tokens=10
    )
    print("✅ API连接成功！")
    print(response.choices[0].message.content)
except Exception as e:
    print("❌ API连接失败：", str(e))
```

运行测试：
```bash
python test_api.py
```

---

## 联系支持

如果以上方案都无法解决问题：
1. 记录完整的错误信息
2. 记录操作步骤
3. 截图错误界面
4. 查看服务器日志
5. 检查网络连接

---

## 最佳实践

### 性能优化
1. 简历控制在5页以内效果最好
2. 避免上传过大的PDF文件
3. 对话时提问具体明确
4. 定期清除不需要的对话历史

### 成本控制
1. 使用DeepSeek模型（性价比最高）
2. 避免重复上传同一份简历
3. 提问时避免过于宽泛
4. 批量筛选和对话结合使用

### 安全建议
1. 不要分享.env文件
2. 定期更换API密钥
3. 不要将敏感简历信息外泄
4. 遵守OpenRouter的使用条款
